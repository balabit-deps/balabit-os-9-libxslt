From 452fb4ca9b9803448826008b9573987c615912a1 Mon Sep 17 00:00:00 2001
From: Nick Wellnhofer <wellnhofer@aevum.de>
Date: Wed, 31 Aug 2022 21:37:44 +0200
Subject: [PATCH] Clean up attributes in source doc

Also make bit flag constants unsigned to avoid implicit-conversion
warnings.
---
 libxslt/transform.c | 10 ++++++++++
 libxslt/xsltutils.h |  6 +++---
 2 files changed, 13 insertions(+), 3 deletions(-)

Index: libxslt-1.1.34/libxslt/transform.c
===================================================================
--- libxslt-1.1.34.orig/libxslt/transform.c	2025-06-19 18:11:06.139734473 -0400
+++ libxslt-1.1.34/libxslt/transform.c	2025-06-19 18:11:06.136734514 -0400
@@ -5761,6 +5761,16 @@
         if (psviPtr)
             *psviPtr = NULL;
 
+        if (cur->type == XML_ELEMENT_NODE) {
+            xmlAttrPtr prop = cur->properties;
+
+            while (prop) {
+                prop->atype &= ~(XSLT_SOURCE_NODE_MASK << 27);
+                prop->psvi = NULL;
+                prop = prop->next;
+            }
+        }
+
         if (cur->children != NULL && cur->type != XML_ENTITY_REF_NODE) {
             cur = cur->children;
         } else {
Index: libxslt-1.1.34/libxslt/xsltutils.h
===================================================================
--- libxslt-1.1.34.orig/libxslt/xsltutils.h	2025-06-19 18:11:06.139734473 -0400
+++ libxslt-1.1.34/libxslt/xsltutils.h	2025-06-19 18:11:06.136734514 -0400
@@ -248,9 +248,9 @@
 						 int flags);
 
 #ifdef IN_LIBXSLT
-#define XSLT_SOURCE_NODE_MASK       15
-#define XSLT_SOURCE_NODE_HAS_KEY    1
-#define XSLT_SOURCE_NODE_HAS_ID     2
+#define XSLT_SOURCE_NODE_MASK       15u
+#define XSLT_SOURCE_NODE_HAS_KEY    1u
+#define XSLT_SOURCE_NODE_HAS_ID     2u
 int
 xsltGetSourceNodeFlags(xmlNodePtr node);
 int
